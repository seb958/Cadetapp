#!/usr/bin/env python3
"""
Tests pour v√©rifier les permissions pr√©sences avec has_admin_privileges
Demande sp√©cifique: Tester que les cadets avec has_admin_privileges=True peuvent prendre les pr√©sences
"""

import requests
import json
from datetime import datetime, date
import sys

# Configuration
BASE_URL = "https://squadcommand.preview.emergentagent.com/api"
ADMIN_USERNAME = "aadministrateur"
ADMIN_PASSWORD = "admin123"

class TestResults:
    def __init__(self):
        self.total_tests = 0
        self.passed_tests = 0
        self.failed_tests = 0
        self.test_details = []
    
    def add_test(self, name, passed, details=""):
        self.total_tests += 1
        if passed:
            self.passed_tests += 1
            status = "‚úÖ PASS"
        else:
            self.failed_tests += 1
            status = "‚ùå FAIL"
        
        self.test_details.append(f"{status} - {name}: {details}")
        print(f"{status} - {name}: {details}")
    
    def print_summary(self):
        print(f"\n{'='*80}")
        print(f"R√âSUM√â DES TESTS - PERMISSIONS PR√âSENCES has_admin_privileges")
        print(f"{'='*80}")
        print(f"Total: {self.total_tests} | R√©ussis: {self.passed_tests} | √âchou√©s: {self.failed_tests}")
        print(f"Taux de r√©ussite: {(self.passed_tests/self.total_tests*100):.1f}%")
        print(f"{'='*80}")

def get_auth_headers(token):
    return {"Authorization": f"Bearer {token}"}

def login_user(username, password):
    """Connexion utilisateur et r√©cup√©ration du token"""
    try:
        response = requests.post(f"{BASE_URL}/auth/login", json={
            "username": username,
            "password": password
        })
        if response.status_code == 200:
            data = response.json()
            return data["access_token"], data["user"]
        else:
            return None, None
    except Exception as e:
        print(f"Erreur lors de la connexion: {e}")
        return None, None

def generate_password_for_user(admin_token, user_id):
    """G√©n√®re un mot de passe temporaire pour un utilisateur"""
    try:
        response = requests.post(
            f"{BASE_URL}/users/{user_id}/generate-password",
            headers=get_auth_headers(admin_token)
        )
        if response.status_code == 200:
            return response.json()
        return None
    except Exception as e:
        print(f"Erreur g√©n√©ration mot de passe: {e}")
        return None
def test_permissions_presences_admin_privileges():
    """Test principal des permissions pr√©sences avec has_admin_privileges"""
    results = TestResults()
    
    print("üîê TESTS PERMISSIONS PR√âSENCES - has_admin_privileges")
    print("="*80)
    
    # 1. Connexion admin
    print("\n1Ô∏è‚É£ CONNEXION ADMINISTRATEUR")
    admin_token, admin_user = login_user(ADMIN_USERNAME, ADMIN_PASSWORD)
    
    if not admin_token:
        results.add_test("Connexion admin", False, "Impossible de se connecter en tant qu'admin")
        results.print_summary()
        return results
    
    results.add_test("Connexion admin", True, f"Connect√©: {admin_user['prenom']} {admin_user['nom']}")
    
    # 2. R√©cup√©rer la liste des utilisateurs
    print("\n2Ô∏è‚É£ R√âCUP√âRATION LISTE UTILISATEURS")
    try:
        response = requests.get(f"{BASE_URL}/users", headers=get_auth_headers(admin_token))
        if response.status_code == 200:
            users = response.json()
            results.add_test("GET /api/users", True, f"{len(users)} utilisateurs trouv√©s")
        else:
            results.add_test("GET /api/users", False, f"Status: {response.status_code}")
            results.print_summary()
            return results
    except Exception as e:
        results.add_test("GET /api/users", False, f"Erreur: {e}")
        results.print_summary()
        return results
    
    def find_user_by_role_keywords(self, keywords):
        """Trouver un utilisateur par mots-cl√©s dans le r√¥le"""
        for role, users in self.users_cache.items():
            if any(keyword.lower() in role for keyword in keywords):
                if users:
                    return users[0]  # Retourner le premier utilisateur trouv√©
        return None
    
    def authenticate_user(self, username, password=None):
        """Authentifier un utilisateur sp√©cifique"""
        # Mots de passe g√©n√©r√©s pour les utilisateurs de test
        user_passwords = {
            "adjudantchef_descadron": "c8iLdxgx",
            "jmoreau": "JWsrp3Od", 
            "sergent_de_section": "Tilr5pxu",
            "aadministrateur": "admin123"
        }
        
        if password is None:
            password = user_passwords.get(username, "admin123")
        
        try:
            response = requests.post(f"{BASE_URL}/auth/login", json={
                "username": username,
                "password": password
            })
            
            if response.status_code == 200:
                data = response.json()
                return data["access_token"]
            else:
                return None
        except Exception as e:
            return None
    
    def test_anti_auto_evaluation(self):
        """Test 1: Anti-Auto-√âvaluation (Critique)"""
        print("\n=== TEST 1: ANTI-AUTO-√âVALUATION ===")
        
        # Trouver des utilisateurs avec diff√©rents r√¥les
        test_users = []
        
        # √âtat-Major (Adjudant d'escadron, Adjudant-chef d'escadron)
        etat_major = self.find_user_by_role_keywords(["adjudant"])
        if etat_major:
            test_users.append(("√âtat-Major", etat_major))
        
        # Commandant de section
        commandant = self.find_user_by_role_keywords(["commandant"])
        if commandant:
            test_users.append(("Commandant de section", commandant))
        
        # Sergent de section
        sergent = self.find_user_by_role_keywords(["sergent"])
        if sergent:
            test_users.append(("Sergent de section", sergent))
        
        if not test_users:
            self.log_test("Anti-Auto-√âvaluation - Utilisateurs trouv√©s", False, "Aucun utilisateur avec r√¥les requis trouv√©")
            return
        
        # Tester l'auto-√©valuation pour chaque type d'utilisateur
        for role_name, user in test_users:
            # Essayer d'authentifier l'utilisateur
            user_token = self.authenticate_user(user.get("username", ""))
            
            if not user_token:
                self.log_test(f"Anti-Auto-√âvaluation - Auth {role_name}", False, f"Impossible d'authentifier {user.get('username', 'N/A')}")
                continue
            
            # Cr√©er une session pour cet utilisateur
            user_session = requests.Session()
            user_session.headers.update({"Authorization": f"Bearer {user_token}"})
            
            # Tenter de cr√©er une inspection o√π l'utilisateur s'inspecte lui-m√™me
            inspection_data = {
                "cadet_id": user["id"],  # L'utilisateur s'inspecte lui-m√™me
                "uniform_type": "C1 - Tenue de Parade",
                "criteria_scores": {
                    "Propret√© g√©n√©rale": 4,
                    "Ajustement": 3,
                    "Accessoires": 4
                },
                "commentaire": "Test auto-√©valuation"
            }
            
            try:
                response = user_session.post(f"{BASE_URL}/uniform-inspections", json=inspection_data)
                
                if response.status_code == 403:
                    response_data = response.json()
                    expected_message = "Vous ne pouvez pas inspecter votre propre uniforme"
                    
                    if expected_message in response_data.get("detail", ""):
                        self.log_test(f"Anti-Auto-√âvaluation - {role_name}", True, 
                                    f"Erreur 403 correcte avec message attendu")
                    else:
                        self.log_test(f"Anti-Auto-√âvaluation - {role_name}", False, 
                                    f"Erreur 403 mais message incorrect: {response_data.get('detail', 'N/A')}")
                else:
                    self.log_test(f"Anti-Auto-√âvaluation - {role_name}", False, 
                                f"Status attendu: 403, re√ßu: {response.status_code}")
                    
            except Exception as e:
                self.log_test(f"Anti-Auto-√âvaluation - {role_name}", False, f"Exception: {str(e)}")
    
    def test_etat_major_permissions(self):
        """Test 2: Permissions √âtat-Major"""
        print("\n=== TEST 2: PERMISSIONS √âTAT-MAJOR ===")
        
        # Trouver un membre de l'√âtat-Major
        etat_major_user = self.find_user_by_role_keywords(["adjudant"])
        
        if not etat_major_user:
            self.log_test("√âtat-Major - Utilisateur trouv√©", False, "Aucun utilisateur √âtat-Major trouv√©")
            return
        
        # Authentifier l'utilisateur √âtat-Major
        user_token = self.authenticate_user(etat_major_user.get("username", ""))
        
        if not user_token:
            self.log_test("√âtat-Major - Authentification", False, f"Impossible d'authentifier {etat_major_user.get('username', 'N/A')}")
            return
        
        self.log_test("√âtat-Major - Authentification", True, f"Utilisateur {etat_major_user.get('prenom', '')} {etat_major_user.get('nom', '')} authentifi√©")
        
        # Cr√©er une session pour cet utilisateur
        user_session = requests.Session()
        user_session.headers.update({"Authorization": f"Bearer {user_token}"})
        
        # Trouver des cadets d'autres sections √† inspecter
        cadets_to_inspect = []
        for role, users in self.users_cache.items():
            if "cadet" in role and role != etat_major_user.get("role", "").lower():
                for user in users:
                    if user["id"] != etat_major_user["id"]:  # Pas lui-m√™me
                        cadets_to_inspect.append(user)
                        if len(cadets_to_inspect) >= 2:  # Limiter √† 2 tests
                            break
            if len(cadets_to_inspect) >= 2:
                break
        
        if not cadets_to_inspect:
            self.log_test("√âtat-Major - Cadets √† inspecter", False, "Aucun cadet trouv√© pour test")
            return
        
        # Tester l'inspection de cadets d'autres sections
        for i, cadet in enumerate(cadets_to_inspect):
            inspection_data = {
                "cadet_id": cadet["id"],
                "uniform_type": "C1 - Tenue de Parade",
                "criteria_scores": {
                    "Propret√© g√©n√©rale": 4,
                    "Ajustement": 3,
                    "Accessoires": 4
                },
                "commentaire": f"Test inspection √âtat-Major #{i+1}"
            }
            
            try:
                response = user_session.post(f"{BASE_URL}/uniform-inspections", json=inspection_data)
                
                if response.status_code == 200 or response.status_code == 201:
                    self.log_test(f"√âtat-Major - Inspection cadet {i+1}", True, 
                                f"Inspection r√©ussie de {cadet.get('prenom', '')} {cadet.get('nom', '')}")
                else:
                    self.log_test(f"√âtat-Major - Inspection cadet {i+1}", False, 
                                f"Status: {response.status_code}, Response: {response.text}")
                    
            except Exception as e:
                self.log_test(f"√âtat-Major - Inspection cadet {i+1}", False, f"Exception: {str(e)}")
    
    def test_section_permissions(self):
        """Test 3: Permissions Section"""
        print("\n=== TEST 3: PERMISSIONS SECTION ===")
        
        # Trouver un Commandant ou Sergent de section
        section_leader = self.find_user_by_role_keywords(["commandant", "sergent"])
        
        if not section_leader:
            self.log_test("Section - Chef trouv√©", False, "Aucun chef de section trouv√©")
            return
        
        # Authentifier le chef de section
        user_token = self.authenticate_user(section_leader.get("username", ""))
        
        if not user_token:
            self.log_test("Section - Authentification", False, f"Impossible d'authentifier {section_leader.get('username', 'N/A')}")
            return
        
        self.log_test("Section - Authentification", True, f"Chef {section_leader.get('prenom', '')} {section_leader.get('nom', '')} authentifi√©")
        
        # Cr√©er une session pour cet utilisateur
        user_session = requests.Session()
        user_session.headers.update({"Authorization": f"Bearer {user_token}"})
        
        # Test 1: Essayer d'inspecter un cadet d'une autre section (doit √©chouer)
        other_section_cadet = None
        for role, users in self.users_cache.items():
            for user in users:
                if (user["id"] != section_leader["id"] and 
                    user.get("section_id") != section_leader.get("section_id") and
                    user.get("section_id") is not None):
                    other_section_cadet = user
                    break
            if other_section_cadet:
                break
        
        if other_section_cadet:
            inspection_data = {
                "cadet_id": other_section_cadet["id"],
                "uniform_type": "C1 - Tenue de Parade",
                "criteria_scores": {
                    "Propret√© g√©n√©rale": 4,
                    "Ajustement": 3
                },
                "commentaire": "Test inspection autre section"
            }
            
            try:
                response = user_session.post(f"{BASE_URL}/uniform-inspections", json=inspection_data)
                
                if response.status_code == 403:
                    self.log_test("Section - Refus autre section", True, 
                                "Inspection d'autre section correctement refus√©e (403)")
                else:
                    self.log_test("Section - Refus autre section", False, 
                                f"Status attendu: 403, re√ßu: {response.status_code}")
                    
            except Exception as e:
                self.log_test("Section - Refus autre section", False, f"Exception: {str(e)}")
        else:
            self.log_test("Section - Cadet autre section", False, "Aucun cadet d'autre section trouv√© pour test")
        
        # Test 2: Inspecter un cadet de sa propre section (doit r√©ussir)
        same_section_cadet = None
        for role, users in self.users_cache.items():
            for user in users:
                if (user["id"] != section_leader["id"] and 
                    user.get("section_id") == section_leader.get("section_id") and
                    user.get("section_id") is not None):
                    same_section_cadet = user
                    break
            if same_section_cadet:
                break
        
        if same_section_cadet:
            inspection_data = {
                "cadet_id": same_section_cadet["id"],
                "uniform_type": "C1 - Tenue de Parade",
                "criteria_scores": {
                    "Propret√© g√©n√©rale": 4,
                    "Ajustement": 3,
                    "Accessoires": 4
                },
                "commentaire": "Test inspection m√™me section"
            }
            
            try:
                response = user_session.post(f"{BASE_URL}/uniform-inspections", json=inspection_data)
                
                if response.status_code == 200 or response.status_code == 201:
                    self.log_test("Section - Inspection m√™me section", True, 
                                f"Inspection de sa section r√©ussie")
                else:
                    self.log_test("Section - Inspection m√™me section", False, 
                                f"Status: {response.status_code}, Response: {response.text}")
                    
            except Exception as e:
                self.log_test("Section - Inspection m√™me section", False, f"Exception: {str(e)}")
        else:
            self.log_test("Section - Cadet m√™me section", False, "Aucun cadet de m√™me section trouv√© pour test")
    
    def test_regression(self):
        """Test 4: R√©gression - V√©rifier que les fonctionnalit√©s existantes marchent"""
        print("\n=== TEST 4: R√âGRESSION ===")
        
        # Test 1: GET /api/users fonctionne toujours
        try:
            response = self.session.get(f"{BASE_URL}/users")
            if response.status_code == 200:
                users = response.json()
                self.log_test("R√©gression - GET /api/users", True, f"{len(users)} utilisateurs r√©cup√©r√©s")
            else:
                self.log_test("R√©gression - GET /api/users", False, f"Status: {response.status_code}")
        except Exception as e:
            self.log_test("R√©gression - GET /api/users", False, f"Exception: {str(e)}")
        
        # Test 2: Inspection valide par admin fonctionne toujours
        if len(self.users_cache) > 0:
            # Trouver un cadet √† inspecter (pas l'admin lui-m√™me)
            cadet_to_inspect = None
            for role, users in self.users_cache.items():
                for user in users:
                    if user["id"] != "0c9b2a6e-2d0e-4590-9e83-3071b411e591":  # Pas l'admin
                        cadet_to_inspect = user
                        break
                if cadet_to_inspect:
                    break
            
            if cadet_to_inspect:
                inspection_data = {
                    "cadet_id": cadet_to_inspect["id"],
                    "uniform_type": "C5 - Tenue d'Entra√Ænement",
                    "criteria_scores": {
                        "Propret√© g√©n√©rale": 3,
                        "Ajustement": 4,
                        "Accessoires": 2,
                        "√âtat g√©n√©ral": 3
                    },
                    "commentaire": "Test r√©gression - inspection valide par admin"
                }
                
                try:
                    response = self.session.post(f"{BASE_URL}/uniform-inspections", json=inspection_data)
                    
                    if response.status_code == 200 or response.status_code == 201:
                        self.log_test("R√©gression - Inspection valide admin", True, 
                                    f"Inspection admin r√©ussie")
                    else:
                        self.log_test("R√©gression - Inspection valide admin", False, 
                                    f"Status: {response.status_code}, Response: {response.text}")
                        
                except Exception as e:
                    self.log_test("R√©gression - Inspection valide admin", False, f"Exception: {str(e)}")
            else:
                self.log_test("R√©gression - Cadet pour inspection", False, "Aucun cadet trouv√© pour test")
        
        # Test 3: GET /api/uniform-inspections fonctionne
        try:
            response = self.session.get(f"{BASE_URL}/uniform-inspections")
            if response.status_code == 200:
                inspections = response.json()
                self.log_test("R√©gression - GET /api/uniform-inspections", True, 
                            f"{len(inspections)} inspections r√©cup√©r√©es")
            else:
                self.log_test("R√©gression - GET /api/uniform-inspections", False, 
                            f"Status: {response.status_code}")
        except Exception as e:
            self.log_test("R√©gression - GET /api/uniform-inspections", False, f"Exception: {str(e)}")
    
    def run_all_tests(self):
        """Ex√©cuter tous les tests"""
        print("üöÄ D√âBUT DES TESTS - PERMISSIONS INSPECTION + ANTI-AUTO-√âVALUATION")
        print(f"Base URL: {BASE_URL}")
        print(f"Admin: {ADMIN_USERNAME}")
        
        # Authentification admin
        if not self.authenticate_admin():
            print("‚ùå √âCHEC - Impossible de s'authentifier en tant qu'admin")
            return False
        
        # R√©cup√©rer les utilisateurs
        users = self.get_users()
        if not users:
            print("‚ùå √âCHEC - Impossible de r√©cup√©rer les utilisateurs")
            return False
        
        # Afficher les r√¥les disponibles pour debug
        print(f"\nüìã R√¥les disponibles: {list(self.users_cache.keys())}")
        
        # Ex√©cuter les tests
        self.test_anti_auto_evaluation()
        self.test_etat_major_permissions()
        self.test_section_permissions()
        self.test_regression()
        
        # R√©sum√© final
        self.print_summary()
        
        return True
    
    def print_summary(self):
        """Afficher le r√©sum√© des tests"""
        print("\n" + "="*60)
        print("üìä R√âSUM√â DES TESTS")
        print("="*60)
        
        total_tests = len(self.test_results)
        passed_tests = len([t for t in self.test_results if t["success"]])
        failed_tests = total_tests - passed_tests
        
        print(f"Total: {total_tests} tests")
        print(f"‚úÖ R√©ussis: {passed_tests}")
        print(f"‚ùå √âchou√©s: {failed_tests}")
        print(f"üìà Taux de r√©ussite: {(passed_tests/total_tests*100):.1f}%")
        
        if failed_tests > 0:
            print(f"\n‚ùå TESTS √âCHOU√âS:")
            for test in self.test_results:
                if not test["success"]:
                    print(f"   - {test['name']}: {test['details']}")
        
        print("\nüéØ FOCUS: Validation anti-auto-√©valuation (priorit√© maximale)")
        
        # V√©rifier si les tests critiques ont r√©ussi
        anti_eval_tests = [t for t in self.test_results if "Anti-Auto-√âvaluation" in t["name"]]
        if anti_eval_tests:
            anti_eval_success = all(t["success"] for t in anti_eval_tests)
            if anti_eval_success:
                print("‚úÖ CRITIQUE: Anti-auto-√©valuation fonctionne correctement")
            else:
                print("‚ùå CRITIQUE: Probl√®mes d√©tect√©s dans l'anti-auto-√©valuation")

def main():
    """Fonction principale"""
    test_runner = TestRunner()
    success = test_runner.run_all_tests()
    
    if success:
        print("\nüéâ Tests termin√©s avec succ√®s")
        return 0
    else:
        print("\nüí• √âchec des tests")
        return 1

if __name__ == "__main__":
    sys.exit(main())