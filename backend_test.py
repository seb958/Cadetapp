#!/usr/bin/env python3
"""
Tests complets pour le syst√®me de sous-groupes nouvellement impl√©ment√©
Test du syst√®me de gestion d'escadron de cadets - Focus sur les sous-groupes
"""

import requests
import json
from datetime import datetime, date
import uuid

# Configuration
BASE_URL = "https://squadron-app.preview.emergentagent.com/api"
ADMIN_USERNAME = "aadministrateur"
ADMIN_PASSWORD = "admin123"

class SubgroupSystemTester:
    def __init__(self):
        self.session = requests.Session()
        self.admin_token = None
        self.test_data = {
            'sections': [],
            'subgroups': [],
            'users': []
        }
        
    def authenticate_admin(self):
        """Authentification avec le compte administrateur"""
        print("üîê Authentification administrateur...")
        
        login_data = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD
        }
        
        response = self.session.post(f"{BASE_URL}/auth/login", json=login_data)
        
        if response.status_code == 200:
            data = response.json()
            self.admin_token = data["access_token"]
            self.session.headers.update({"Authorization": f"Bearer {self.admin_token}"})
            print(f"‚úÖ Authentification r√©ussie - Token obtenu")
            return True
        else:
            print(f"‚ùå √âchec authentification: {response.status_code} - {response.text}")
            return False
    
    def test_subgroup_crud_endpoints(self):
        """Test des endpoints CRUD pour les sous-groupes"""
        print("\nüìã === TEST ENDPOINTS CRUD SOUS-GROUPES ===")
        
        results = {
            'get_subgroups': False,
            'create_subgroup': False,
            'update_subgroup': False,
            'delete_subgroup': False
        }
        
        try:
            # 1. Cr√©er une section de test
            print("\n1Ô∏è‚É£ Cr√©ation section de test...")
            section_data = {
                "nom": f"Section Test Sous-groupes {datetime.now().strftime('%H%M%S')}",
                "description": "Section cr√©√©e pour tester les sous-groupes"
            }
            
            response = self.session.post(f"{BASE_URL}/sections", json=section_data)
            if response.status_code == 200:
                section = response.json()
                self.test_data['sections'].append(section['id'])
                print(f"‚úÖ Section cr√©√©e: {section['id']}")
            else:
                print(f"‚ùå Erreur cr√©ation section: {response.status_code} - {response.text}")
                return results
            
            section_id = section['id']
            
            # 2. Test GET /api/sections/{section_id}/subgroups (vide initialement)
            print("\n2Ô∏è‚É£ Test GET sous-groupes (section vide)...")
            response = self.session.get(f"{BASE_URL}/sections/{section_id}/subgroups")
            if response.status_code == 200:
                subgroups = response.json()
                if isinstance(subgroups, list) and len(subgroups) == 0:
                    print("‚úÖ GET sous-groupes fonctionne (liste vide)")
                    results['get_subgroups'] = True
                else:
                    print(f"‚ö†Ô∏è R√©ponse inattendue: {subgroups}")
            else:
                print(f"‚ùå Erreur GET sous-groupes: {response.status_code} - {response.text}")
            
            # 3. Test POST /api/subgroups - Cr√©ation sous-groupe
            print("\n3Ô∏è‚É£ Test POST cr√©ation sous-groupe...")
            subgroup_data = {
                "nom": f"Sous-groupe Alpha {datetime.now().strftime('%H%M%S')}",
                "description": "Premier sous-groupe de test",
                "section_id": section_id
            }
            
            response = self.session.post(f"{BASE_URL}/subgroups", json=subgroup_data)
            if response.status_code == 200:
                subgroup = response.json()
                self.test_data['subgroups'].append(subgroup['id'])
                print(f"‚úÖ Sous-groupe cr√©√©: {subgroup['id']}")
                print(f"   Nom: {subgroup['nom']}")
                print(f"   Section: {subgroup['section_id']}")
                results['create_subgroup'] = True
                subgroup_id = subgroup['id']
            else:
                print(f"‚ùå Erreur cr√©ation sous-groupe: {response.status_code} - {response.text}")
                return results
            
            # 4. V√©rifier GET apr√®s cr√©ation
            print("\n4Ô∏è‚É£ V√©rification GET apr√®s cr√©ation...")
            response = self.session.get(f"{BASE_URL}/sections/{section_id}/subgroups")
            if response.status_code == 200:
                subgroups = response.json()
                if len(subgroups) == 1 and subgroups[0]['id'] == subgroup_id:
                    print("‚úÖ GET sous-groupes retourne le sous-groupe cr√©√©")
                else:
                    print(f"‚ö†Ô∏è Sous-groupe non trouv√© dans la liste: {subgroups}")
            
            # 5. Test PUT /api/subgroups/{subgroup_id} - Mise √† jour
            print("\n5Ô∏è‚É£ Test PUT mise √† jour sous-groupe...")
            update_data = {
                "nom": f"Sous-groupe Alpha Modifi√© {datetime.now().strftime('%H%M%S')}",
                "description": "Description mise √† jour"
            }
            
            response = self.session.put(f"{BASE_URL}/subgroups/{subgroup_id}", json=update_data)
            if response.status_code == 200:
                print("‚úÖ Mise √† jour sous-groupe r√©ussie")
                results['update_subgroup'] = True
                
                # V√©rifier la mise √† jour
                response = self.session.get(f"{BASE_URL}/sections/{section_id}/subgroups")
                if response.status_code == 200:
                    subgroups = response.json()
                    updated_subgroup = next((sg for sg in subgroups if sg['id'] == subgroup_id), None)
                    if updated_subgroup and updated_subgroup['nom'] == update_data['nom']:
                        print("‚úÖ V√©rification mise √† jour: nom correctement modifi√©")
                    else:
                        print("‚ö†Ô∏è Mise √† jour non refl√©t√©e dans GET")
            else:
                print(f"‚ùå Erreur mise √† jour sous-groupe: {response.status_code} - {response.text}")
            
            # 6. Test DELETE /api/subgroups/{subgroup_id} - Suppression
            print("\n6Ô∏è‚É£ Test DELETE suppression sous-groupe...")
            response = self.session.delete(f"{BASE_URL}/subgroups/{subgroup_id}")
            if response.status_code == 200:
                print("‚úÖ Suppression sous-groupe r√©ussie")
                results['delete_subgroup'] = True
                
                # V√©rifier la suppression
                response = self.session.get(f"{BASE_URL}/sections/{section_id}/subgroups")
                if response.status_code == 200:
                    subgroups = response.json()
                    if len(subgroups) == 0:
                        print("‚úÖ V√©rification suppression: liste vide")
                    else:
                        print(f"‚ö†Ô∏è Sous-groupe encore pr√©sent apr√®s suppression: {subgroups}")
                
                # Retirer de nos donn√©es de test
                if subgroup_id in self.test_data['subgroups']:
                    self.test_data['subgroups'].remove(subgroup_id)
            else:
                print(f"‚ùå Erreur suppression sous-groupe: {response.status_code} - {response.text}")
                
        except Exception as e:
            print(f"‚ùå Exception dans test CRUD: {str(e)}")
        
        return results
    
    def test_user_subgroup_integration(self):
        """Test de l'int√©gration utilisateur-sous-groupe"""
        print("\nüë• === TEST INT√âGRATION UTILISATEUR-SOUS-GROUPE ===")
        
        results = {
            'user_creation_with_subgroup': False,
            'user_update_subgroup': False,
            'subgroup_section_validation': False
        }
        
        try:
            # 1. Cr√©er section et sous-groupe pour les tests
            print("\n1Ô∏è‚É£ Pr√©paration: cr√©ation section et sous-groupe...")
            
            # Cr√©er section
            section_data = {
                "nom": f"Section Int√©gration {datetime.now().strftime('%H%M%S')}",
                "description": "Section pour test int√©gration utilisateur-sous-groupe"
            }
            response = self.session.post(f"{BASE_URL}/sections", json=section_data)
            if response.status_code != 200:
                print(f"‚ùå Erreur cr√©ation section: {response.text}")
                return results
            
            section = response.json()
            section_id = section['id']
            self.test_data['sections'].append(section_id)
            
            # Cr√©er sous-groupe
            subgroup_data = {
                "nom": f"Sous-groupe Beta {datetime.now().strftime('%H%M%S')}",
                "description": "Sous-groupe pour test int√©gration",
                "section_id": section_id
            }
            response = self.session.post(f"{BASE_URL}/subgroups", json=subgroup_data)
            if response.status_code != 200:
                print(f"‚ùå Erreur cr√©ation sous-groupe: {response.text}")
                return results
            
            subgroup = response.json()
            subgroup_id = subgroup['id']
            self.test_data['subgroups'].append(subgroup_id)
            print(f"‚úÖ Section {section_id} et sous-groupe {subgroup_id} cr√©√©s")
            
            # 2. Test cr√©ation utilisateur avec sous-groupe
            print("\n2Ô∏è‚É£ Test cr√©ation utilisateur avec sous-groupe...")
            user_data = {
                "nom": "TestSubgroup",
                "prenom": f"Cadet{datetime.now().strftime('%H%M%S')}",
                "email": f"cadet.subgroup.{datetime.now().strftime('%H%M%S')}@test.fr",
                "grade": "cadet",
                "role": "cadet",
                "section_id": section_id,
                "subgroup_id": subgroup_id,
                "has_admin_privileges": False
            }
            
            response = self.session.post(f"{BASE_URL}/users", json=user_data)
            if response.status_code == 200:
                user_result = response.json()
                user_id = user_result['user_id']
                self.test_data['users'].append(user_id)
                print(f"‚úÖ Utilisateur cr√©√© avec sous-groupe: {user_id}")
                results['user_creation_with_subgroup'] = True
                
                # V√©rifier que l'utilisateur a bien le sous-groupe
                response = self.session.get(f"{BASE_URL}/users/{user_id}")
                if response.status_code == 200:
                    user = response.json()
                    if user.get('subgroup_id') == subgroup_id:
                        print("‚úÖ V√©rification: utilisateur a le bon sous-groupe")
                    else:
                        print(f"‚ö†Ô∏è Sous-groupe incorrect: attendu {subgroup_id}, re√ßu {user.get('subgroup_id')}")
            else:
                print(f"‚ùå Erreur cr√©ation utilisateur: {response.status_code} - {response.text}")
            
            # 3. Test mise √† jour sous-groupe utilisateur
            print("\n3Ô∏è‚É£ Test mise √† jour sous-groupe utilisateur...")
            
            # Cr√©er un deuxi√®me sous-groupe
            subgroup2_data = {
                "nom": f"Sous-groupe Gamma {datetime.now().strftime('%H%M%S')}",
                "description": "Deuxi√®me sous-groupe pour test",
                "section_id": section_id
            }
            response = self.session.post(f"{BASE_URL}/subgroups", json=subgroup2_data)
            if response.status_code == 200:
                subgroup2 = response.json()
                subgroup2_id = subgroup2['id']
                self.test_data['subgroups'].append(subgroup2_id)
                
                # Mettre √† jour l'utilisateur
                update_data = {"subgroup_id": subgroup2_id}
                response = self.session.put(f"{BASE_URL}/users/{user_id}", json=update_data)
                if response.status_code == 200:
                    print("‚úÖ Mise √† jour sous-groupe utilisateur r√©ussie")
                    results['user_update_subgroup'] = True
                    
                    # V√©rifier la mise √† jour
                    response = self.session.get(f"{BASE_URL}/users/{user_id}")
                    if response.status_code == 200:
                        user = response.json()
                        if user.get('subgroup_id') == subgroup2_id:
                            print("‚úÖ V√©rification: sous-groupe utilisateur mis √† jour")
                        else:
                            print(f"‚ö†Ô∏è Mise √† jour non refl√©t√©e: {user.get('subgroup_id')}")
                else:
                    print(f"‚ùå Erreur mise √† jour utilisateur: {response.text}")
            
            # 4. Test validation section-sous-groupe
            print("\n4Ô∏è‚É£ Test validation coh√©rence section-sous-groupe...")
            
            # Cr√©er une autre section
            other_section_data = {
                "nom": f"Autre Section {datetime.now().strftime('%H%M%S')}",
                "description": "Section pour test validation"
            }
            response = self.session.post(f"{BASE_URL}/sections", json=other_section_data)
            if response.status_code == 200:
                other_section = response.json()
                other_section_id = other_section['id']
                self.test_data['sections'].append(other_section_id)
                
                # Essayer d'assigner un utilisateur √† un sous-groupe d'une autre section
                invalid_update = {
                    "section_id": other_section_id,
                    "subgroup_id": subgroup_id  # Sous-groupe de la premi√®re section
                }
                
                response = self.session.put(f"{BASE_URL}/users/{user_id}", json=invalid_update)
                if response.status_code == 400:
                    print("‚úÖ Validation section-sous-groupe: erreur 400 attendue")
                    results['subgroup_section_validation'] = True
                elif response.status_code != 200:
                    print(f"‚úÖ Validation section-sous-groupe: erreur {response.status_code} (validation active)")
                    results['subgroup_section_validation'] = True
                else:
                    print("‚ö†Ô∏è Validation section-sous-groupe: aucune erreur (validation manquante?)")
                    
        except Exception as e:
            print(f"‚ùå Exception dans test int√©gration: {str(e)}")
        
        return results
    
    def test_error_scenarios(self):
        """Test des sc√©narios d'erreur"""
        print("\nüö® === TEST SC√âNARIOS D'ERREUR ===")
        
        results = {
            'nonexistent_section_subgroup_creation': False,
            'nonexistent_subgroup_user_assignment': False,
            'duplicate_subgroup_name': False
        }
        
        try:
            # 1. Test cr√©ation sous-groupe avec section inexistante
            print("\n1Ô∏è‚É£ Test cr√©ation sous-groupe avec section inexistante...")
            fake_section_id = str(uuid.uuid4())
            
            subgroup_data = {
                "nom": "Sous-groupe Erreur",
                "description": "Test avec section inexistante",
                "section_id": fake_section_id
            }
            
            response = self.session.post(f"{BASE_URL}/subgroups", json=subgroup_data)
            if response.status_code == 404:
                print("‚úÖ Erreur 404 pour section inexistante")
                results['nonexistent_section_subgroup_creation'] = True
            elif response.status_code != 200:
                print(f"‚úÖ Erreur {response.status_code} pour section inexistante (validation active)")
                results['nonexistent_section_subgroup_creation'] = True
            else:
                print("‚ö†Ô∏è Aucune erreur pour section inexistante (validation manquante)")
            
            # 2. Test assignation utilisateur √† sous-groupe inexistant
            print("\n2Ô∏è‚É£ Test assignation utilisateur √† sous-groupe inexistant...")
            
            # D'abord cr√©er un utilisateur valide
            section_data = {
                "nom": f"Section Erreur {datetime.now().strftime('%H%M%S')}",
                "description": "Section pour test erreur"
            }
            response = self.session.post(f"{BASE_URL}/sections", json=section_data)
            if response.status_code == 200:
                section = response.json()
                section_id = section['id']
                self.test_data['sections'].append(section_id)
                
                user_data = {
                    "nom": "TestErreur",
                    "prenom": f"Cadet{datetime.now().strftime('%H%M%S')}",
                    "grade": "cadet",
                    "role": "cadet",
                    "section_id": section_id
                }
                
                response = self.session.post(f"{BASE_URL}/users", json=user_data)
                if response.status_code == 200:
                    user_result = response.json()
                    user_id = user_result['user_id']
                    self.test_data['users'].append(user_id)
                    
                    # Essayer d'assigner un sous-groupe inexistant
                    fake_subgroup_id = str(uuid.uuid4())
                    update_data = {"subgroup_id": fake_subgroup_id}
                    
                    response = self.session.put(f"{BASE_URL}/users/{user_id}", json=update_data)
                    if response.status_code == 404:
                        print("‚úÖ Erreur 404 pour sous-groupe inexistant")
                        results['nonexistent_subgroup_user_assignment'] = True
                    elif response.status_code != 200:
                        print(f"‚úÖ Erreur {response.status_code} pour sous-groupe inexistant (validation active)")
                        results['nonexistent_subgroup_user_assignment'] = True
                    else:
                        print("‚ö†Ô∏è Aucune erreur pour sous-groupe inexistant (validation manquante)")
            
            # 3. Test nom de sous-groupe dupliqu√© dans m√™me section
            print("\n3Ô∏è‚É£ Test nom de sous-groupe dupliqu√©...")
            
            if section_id:
                # Cr√©er premier sous-groupe
                subgroup_data = {
                    "nom": f"Sous-groupe Unique {datetime.now().strftime('%H%M%S')}",
                    "description": "Premier sous-groupe",
                    "section_id": section_id
                }
                
                response = self.session.post(f"{BASE_URL}/subgroups", json=subgroup_data)
                if response.status_code == 200:
                    subgroup = response.json()
                    self.test_data['subgroups'].append(subgroup['id'])
                    
                    # Essayer de cr√©er un deuxi√®me avec le m√™me nom
                    duplicate_data = {
                        "nom": subgroup_data["nom"],  # M√™me nom
                        "description": "Tentative de duplication",
                        "section_id": section_id
                    }
                    
                    response = self.session.post(f"{BASE_URL}/subgroups", json=duplicate_data)
                    if response.status_code == 400:
                        print("‚úÖ Erreur 400 pour nom dupliqu√©")
                        results['duplicate_subgroup_name'] = True
                    elif response.status_code != 200:
                        print(f"‚úÖ Erreur {response.status_code} pour nom dupliqu√© (validation active)")
                        results['duplicate_subgroup_name'] = True
                    else:
                        print("‚ö†Ô∏è Aucune erreur pour nom dupliqu√© (validation manquante)")
                        # Si cr√©√© par erreur, l'ajouter pour nettoyage
                        if response.json().get('id'):
                            self.test_data['subgroups'].append(response.json()['id'])
                            
        except Exception as e:
            print(f"‚ùå Exception dans test erreurs: {str(e)}")
        
        return results
    
    def cleanup_test_data(self):
        """Nettoyer les donn√©es de test cr√©√©es"""
        print("\nüßπ === NETTOYAGE DONN√âES DE TEST ===")
        
        # Supprimer les utilisateurs
        for user_id in self.test_data['users']:
            try:
                response = self.session.delete(f"{BASE_URL}/users/{user_id}")
                if response.status_code == 200:
                    print(f"‚úÖ Utilisateur {user_id} supprim√©")
                else:
                    print(f"‚ö†Ô∏è Erreur suppression utilisateur {user_id}: {response.status_code}")
            except Exception as e:
                print(f"‚ö†Ô∏è Exception suppression utilisateur {user_id}: {str(e)}")
        
        # Supprimer les sous-groupes
        for subgroup_id in self.test_data['subgroups']:
            try:
                response = self.session.delete(f"{BASE_URL}/subgroups/{subgroup_id}")
                if response.status_code == 200:
                    print(f"‚úÖ Sous-groupe {subgroup_id} supprim√©")
                else:
                    print(f"‚ö†Ô∏è Erreur suppression sous-groupe {subgroup_id}: {response.status_code}")
            except Exception as e:
                print(f"‚ö†Ô∏è Exception suppression sous-groupe {subgroup_id}: {str(e)}")
        
        # Supprimer les sections
        for section_id in self.test_data['sections']:
            try:
                response = self.session.delete(f"{BASE_URL}/sections/{section_id}")
                if response.status_code == 200:
                    print(f"‚úÖ Section {section_id} supprim√©e")
                else:
                    print(f"‚ö†Ô∏è Erreur suppression section {section_id}: {response.status_code}")
            except Exception as e:
                print(f"‚ö†Ô∏è Exception suppression section {section_id}: {str(e)}")
        
        print("üßπ Nettoyage termin√©")
    
    def run_all_tests(self):
        """Ex√©cuter tous les tests"""
        print("üöÄ === D√âBUT TESTS SYST√àME SOUS-GROUPES ===")
        print(f"üåê Base URL: {BASE_URL}")
        print(f"üë§ Authentification: {ADMIN_USERNAME}")
        
        # Authentification
        if not self.authenticate_admin():
            print("‚ùå √âchec authentification - Arr√™t des tests")
            return
        
        all_results = {}
        
        try:
            # Test 1: CRUD endpoints
            print("\n" + "="*60)
            crud_results = self.test_subgroup_crud_endpoints()
            all_results.update(crud_results)
            
            # Test 2: Int√©gration utilisateur-sous-groupe
            print("\n" + "="*60)
            integration_results = self.test_user_subgroup_integration()
            all_results.update(integration_results)
            
            # Test 3: Sc√©narios d'erreur
            print("\n" + "="*60)
            error_results = self.test_error_scenarios()
            all_results.update(error_results)
            
        finally:
            # Nettoyage (toujours ex√©cut√©)
            print("\n" + "="*60)
            self.cleanup_test_data()
        
        # R√©sum√© final
        print("\n" + "="*60)
        print("üìä === R√âSUM√â FINAL ===")
        
        total_tests = len(all_results)
        passed_tests = sum(1 for result in all_results.values() if result)
        success_rate = (passed_tests / total_tests * 100) if total_tests > 0 else 0
        
        print(f"üìà Tests r√©ussis: {passed_tests}/{total_tests} ({success_rate:.1f}%)")
        
        print("\nüìã D√©tail des r√©sultats:")
        for test_name, result in all_results.items():
            status = "‚úÖ R√âUSSI" if result else "‚ùå √âCHEC"
            print(f"  {status} - {test_name}")
        
        if success_rate >= 80:
            print(f"\nüéâ SYST√àME SOUS-GROUPES FONCTIONNEL ({success_rate:.1f}% r√©ussite)")
        else:
            print(f"\n‚ö†Ô∏è PROBL√àMES D√âTECT√âS DANS LE SYST√àME SOUS-GROUPES ({success_rate:.1f}% r√©ussite)")
        
        return all_results

if __name__ == "__main__":
    tester = SubgroupSystemTester()
    results = tester.run_all_tests()